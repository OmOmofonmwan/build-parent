name: Build Workflow

run-name: 'Build Workflow For ${{github.ref_name}}'

on:
    push:

jobs:
  build-job:
    name: Build Job
    runs-on: ubuntu-latest
    steps:
          - name: Checkout Code Repository
            uses: actions/checkout@v4
          - name: Downloading Java
            uses: actions/setup-java@v4
            with:
                java-version: '21'
                distribution: 'adopt'
          - name: Maven Build
            if: github.ref == 'refs/heads/main'
            run: |
              java --version
              mvn clean install \
                --batch-mode \
                -e \
                -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                -PcodeQuality
          - name: Maven Build -- Feature Branch
            if: github.ref != 'refs/heads/main'
            run: |
              java --version
              mvn clean install \
                --batch-mode \
                -e \
                -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                -PcodeQuality
          - name: Settings.xml Config
            uses: whelk-io/maven-settings-xml-action@v22
            with:
                servers: > 
                        [
                          {
                            "id": "nexus"
                          },
                          {
                            "id": "${{vars.NEXUS_SNAPSHOT_REPO_ID}}",
                            "username": "${{ vars.NEXUS_USERNAME }}",
                            "password": "${{ secrets.NEXUS_PASSWORD}}"
                          },
                          {
                            "id": "${{vars.NEXUS_MIRROR_ID}}",
                            "username": "${{ vars.NEXUS_USERNAME }}",
                            "password": "${{ secrets.NEXUS_PASSWORD}}"
                          }
                        ] 
                profiles: >
                       [{
                            "id": "inject-application-properties",
                            "properties": {
                                "altSnapshotDeploymentRepository": "${{vars.NEXUS_SNAPSHOT_REPO_ID}}::${{vars.NEXUS_SNAPSHOT_REPO_URL}}",
                                "altReleaseDeploymentRepository": "${{vars.NEXUS_SNAPSHOT_REPO_ID}}::${{vars.NEXUS_RELEASE_REPO_URL}}"
                            }
                       }]
                active_profiles: > 
                       [
                          "inject-application-properties"
                       ]
                mirrors: >
                       [{
                           "id": "${{vars.NEXUS_MIRROR_ID}}",
                           "name": "${{vars.NEXUS_MIRROR_ID}}",
                           "url": "${{vars.NEXUS_MIRROR_URL}}",
                           "mirrorOf": "*"
                       }]
                output_file: .m2/settings.xml
          - name: Deploy To Nexus
            run: |
                   mvn deploy \
                      --batch-mode \
                      -e \
                      -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                      -DskipTests \
                      -DskipITs \
                      -Dmaven.main.skip \
                      -Dmaven.test.skip \
                      -s '/home/runner/.m2/settings.xml' \
                      -DrepositoryId='maven-snapshots' \
                      -Dgpg.passphrase=${{secrets.GPG_PASSPHRASE}}
